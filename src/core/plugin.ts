/**
 * Mini-Koishi æ’ä»¶ç³»ç»Ÿ (Plugin)
 *
 * ğŸ“ å­¦ä¹ è¦ç‚¹ï¼š
 * Koishi çš„æ’ä»¶ç³»ç»Ÿæ˜¯æ¡†æ¶æ¨¡å—åŒ–çš„åŸºçŸ³ã€‚æ ¸å¿ƒåŸç†æ˜¯ï¼š
 *
 * 1. **æ’ä»¶ = ä¸€ä¸ªæ¥å— (ctx, config) çš„å‡½æ•°**
 *    æœ€ç®€å•çš„æ’ä»¶å°±æ˜¯ä¸€ä¸ªå‡½æ•°ï¼Œæ¥æ”¶ä¸Šä¸‹æ–‡å’Œé…ç½®ä½œä¸ºå‚æ•°ã€‚
 *    è¿™æ„å‘³ç€æ’ä»¶ä¸éœ€è¦ç»§æ‰¿ä»»ä½•ç±»ï¼Œä¸éœ€è¦å®ç°ä»»ä½•æ¥å£ï¼Œ
 *    åªè¦æ˜¯ä¸€ä¸ªå‡½æ•°å°±è¡Œâ€”â€”è¿™æ˜¯æœ€çµæ´»çš„æ‰©å±•æ–¹å¼ã€‚
 *
 * 2. **æ¯ä¸ªæ’ä»¶æœ‰è‡ªå·±çš„å­ä¸Šä¸‹æ–‡**
 *    å½“ä½ é€šè¿‡ ctx.plugin(myPlugin) åŠ è½½æ’ä»¶æ—¶ï¼Œ
 *    æ¡†æ¶ä¼šä¸ºè¯¥æ’ä»¶åˆ›å»ºä¸€ä¸ªç‹¬ç«‹çš„å­ä¸Šä¸‹æ–‡ï¼ˆchild contextï¼‰ã€‚
 *    æ’ä»¶åœ¨å­ä¸Šä¸‹æ–‡ä¸­æ³¨å†Œçš„æ‰€æœ‰ç›‘å¬å™¨ã€æŒ‡ä»¤ç­‰ï¼Œ
 *    éƒ½ä¼šç»‘å®šåˆ°è¿™ä¸ªå­ä¸Šä¸‹æ–‡çš„ lifecycle ä¸Šã€‚
 *
 * 3. **å¸è½½ = é”€æ¯å­ä¸Šä¸‹æ–‡**
 *    å½“éœ€è¦å¸è½½æ’ä»¶æ—¶ï¼Œåªè¦é”€æ¯å®ƒçš„å­ä¸Šä¸‹æ–‡ï¼Œ
 *    æ‰€æœ‰åœ¨è¿™ä¸ªä¸Šä¸‹æ–‡ä¸­æ³¨å†Œçš„å‰¯ä½œç”¨éƒ½ä¼šè‡ªåŠ¨æ¸…ç†ã€‚
 *    è¿™å°±æ˜¯ Koishi èƒ½å®ç°"çƒ­é‡è½½"çš„å…³é”®ã€‚
 *
 * 4. **æ’ä»¶å¯ä»¥åµŒå¥—**
 *    ä¸€ä¸ªæ’ä»¶å¯ä»¥åœ¨å…¶å†…éƒ¨åŠ è½½å…¶ä»–æ’ä»¶ï¼Œå½¢æˆæ ‘çŠ¶ç»“æ„ã€‚
 */

import type { Context } from './context.js';

// ============================================================================
// ç±»å‹å®šä¹‰
// ============================================================================

/**
 * å‡½æ•°å½¢å¼çš„æ’ä»¶
 * ğŸ“ æœ€å¸¸ç”¨çš„æ’ä»¶å½¢å¼ï¼Œç›´æ¥æ˜¯ä¸€ä¸ªå‡½æ•°
 *
 * ç¤ºä¾‹ï¼š
 *   function myPlugin(ctx, config) {
 *     ctx.command('hello', 'æ‰“æ‹›å‘¼').action(() => 'Hello!');
 *   }
 */
export type PluginFunction = (ctx: Context, config?: any) => void;

/**
 * å¯¹è±¡å½¢å¼çš„æ’ä»¶
 * ğŸ“ å½“æ’ä»¶éœ€è¦æºå¸¦é¢å¤–å…ƒä¿¡æ¯ï¼ˆå¦‚åç§°ï¼‰æ—¶ä½¿ç”¨
 *
 * ç¤ºä¾‹ï¼š
 *   const myPlugin = {
 *     name: 'my-plugin',
 *     apply(ctx, config) {
 *       ctx.command('hello', 'æ‰“æ‹›å‘¼').action(() => 'Hello!');
 *     }
 *   }
 */
export interface PluginObject {
  /** æ’ä»¶åç§°ï¼ˆå¯é€‰ï¼Œç”¨äºè°ƒè¯•å’Œå¯è§†åŒ–ï¼‰ */
  name?: string;
  /** æ’ä»¶çš„ apply æ–¹æ³•ï¼Œç­‰ä»·äºå‡½æ•°å½¢å¼æ’ä»¶çš„å‡½æ•°ä½“ */
  apply: PluginFunction;
}

/**
 * æ’ä»¶ç±»å‹ï¼šå¯ä»¥æ˜¯å‡½æ•°æˆ–å¯¹è±¡
 *
 * ğŸ“ Koishi è¿˜æ”¯æŒç±»å½¢å¼çš„æ’ä»¶ï¼ˆclassï¼‰ï¼Œè¿™é‡Œä¸ºäº†ç®€åŒ–åªå®ç°å‡½æ•°å’Œå¯¹è±¡ä¸¤ç§ã€‚
 * åœ¨å®é™… Koishi ä¸­ï¼Œç±»å½¢å¼çš„æ’ä»¶æ„é€ å™¨æ¥æ”¶ (ctx, config) å‚æ•°ã€‚
 */
export type Plugin = PluginFunction | PluginObject;

// ============================================================================
// è¾…åŠ©å‡½æ•°
// ============================================================================

/**
 * è·å–æ’ä»¶åç§°
 *
 * ğŸ“ æ’ä»¶åç§°çš„æ¥æºä¼˜å…ˆçº§ï¼š
 * 1. å¯¹è±¡å½¢å¼æ’ä»¶çš„ name å±æ€§
 * 2. å‡½æ•°çš„ name å±æ€§ï¼ˆå‡½æ•°å£°æ˜æ—¶è‡ªå¸¦ï¼‰
 * 3. åŒ¿åæ’ä»¶è¿”å› 'anonymous'
 */
export function getPluginName(plugin: Plugin): string {
  if (typeof plugin === 'function') {
    return plugin.name || 'anonymous';
  }
  return plugin.name || 'anonymous';
}

/**
 * è·å–æ’ä»¶çš„ apply å‡½æ•°
 *
 * ğŸ“ ç»Ÿä¸€ä¸¤ç§æ’ä»¶å½¢å¼ï¼š
 * - å‡½æ•°å½¢å¼ï¼šæ’ä»¶æœ¬èº«å°±æ˜¯ apply å‡½æ•°
 * - å¯¹è±¡å½¢å¼ï¼šå– plugin.apply
 */
export function getPluginApply(plugin: Plugin): PluginFunction {
  if (typeof plugin === 'function') {
    // ğŸ“ è¿™é‡Œéœ€è¦æ˜¾å¼æ–­è¨€ï¼Œå› ä¸º PluginObject çš„ apply å±æ€§
    //    ä¼šè®© TypeScript è¯¯å°†å…¶ä¸ Function.prototype.apply æ··æ·†ï¼Œ
    //    å¯¼è‡´ç±»å‹æ”¶çª„ä¸å¤Ÿç²¾ç¡®
    return plugin as PluginFunction;
  }
  return plugin.apply;
}
