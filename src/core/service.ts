/**
 * Mini-Koishi æœåŠ¡ç³»ç»Ÿ (Service)
 *
 * ğŸ“ å­¦ä¹ è¦ç‚¹ï¼š
 * Koishi çš„æœåŠ¡ç³»ç»Ÿæœ¬è´¨ä¸Šæ˜¯ä¸€ä¸ª **IoCï¼ˆæ§åˆ¶åè½¬ï¼‰å®¹å™¨**ï¼š
 * 1. æœåŠ¡å¯ä»¥åœ¨è¿è¡Œæ—¶åŠ¨æ€æ³¨å†Œå’Œæ³¨é”€
 * 2. æœåŠ¡é€šè¿‡ ctx.serviceName çš„æ–¹å¼ç›´æ¥è®¿é—®ï¼ˆå€ŸåŠ© Proxy æˆ– getterï¼‰
 * 3. æœåŠ¡å˜æ›´æ—¶ä¼šè§¦å‘ "service" äº‹ä»¶ï¼Œè®©ä¾èµ–æ–¹çŸ¥é“
 * 4. ctx.inject() å¯ä»¥å£°æ˜ä¾èµ–ï¼Œåªæœ‰ä¾èµ–çš„æœåŠ¡å…¨éƒ¨å¯ç”¨æ—¶æ‰æ‰§è¡Œ
 *
 * è¿™ç§è®¾è®¡è®©æ’ä»¶ä¹‹é—´å¯ä»¥æ¾è€¦åˆåœ°åä½œï¼š
 * - æ•°æ®åº“æ’ä»¶æä¾› ctx.database æœåŠ¡
 * - å…¶ä»–æ’ä»¶é€šè¿‡ ctx.inject(['database'], ...) å£°æ˜ä¾èµ–
 * - æ•°æ®åº“æ’ä»¶å¯ä»¥çƒ­æ›¿æ¢ï¼Œä¾èµ–æ–¹è‡ªåŠ¨æ„ŸçŸ¥
 */

import type { Context } from './context.js';

// ============================================================================
// ç±»å‹å®šä¹‰
// ============================================================================

/** æœåŠ¡æè¿°ä¿¡æ¯ */
export interface ServiceMeta {
  /** æœåŠ¡åç§° */
  name: string;
}

// ============================================================================
// ServiceManager ç±»
// ============================================================================

export class ServiceManager {
  /**
   * å·²å£°æ˜çš„æœåŠ¡åç§°é›†åˆ
   * ğŸ“ "å£°æ˜"å’Œ"å®ç°"æ˜¯åˆ†å¼€çš„ï¼š
   * - å£°æ˜ = å‘Šè¯‰æ¡†æ¶"æœ‰è¿™ä¹ˆä¸€ä¸ªæœåŠ¡çš„æ¦‚å¿µ"
   * - å®ç° = æŸä¸ªæ’ä»¶æä¾›äº†è¯¥æœåŠ¡çš„å®é™…å®ä¾‹
   */
  private _declared: Set<string> = new Set();

  /**
   * æœåŠ¡å®ä¾‹å­˜å‚¨
   * key: æœåŠ¡å
   * value: æœåŠ¡å®ä¾‹ï¼ˆä»»æ„ç±»å‹ï¼‰
   */
  private _services: Map<string, any> = new Map();

  /** æŒæœ‰æ ¹ä¸Šä¸‹æ–‡çš„å¼•ç”¨ï¼Œç”¨äºè§¦å‘äº‹ä»¶ */
  private _root: Context;

  constructor(root: Context) {
    this._root = root;
  }

  /**
   * å£°æ˜ä¸€ä¸ªæœåŠ¡
   *
   * ğŸ“ åœ¨ Koishi ä¸­ï¼ŒæœåŠ¡éœ€è¦å…ˆå£°æ˜æ‰èƒ½ä½¿ç”¨ã€‚
   * å£°æ˜æ“ä½œé€šå¸¸åœ¨æ’ä»¶çš„é¡¶å±‚ä½œç”¨åŸŸä¸­è¿›è¡Œï¼š
   *   Context.service('database')
   *
   * å£°æ˜åï¼Œctx.database å°±å¯ä»¥ä½œä¸ºå±æ€§è®¿é—®äº†ï¼ˆè™½ç„¶å¯èƒ½ä¸º undefinedï¼‰
   *
   * @param name - æœåŠ¡åç§°
   */
  declare(name: string): void {
    this._declared.add(name);
  }

  /**
   * æ£€æŸ¥æœåŠ¡æ˜¯å¦å·²å£°æ˜
   */
  isDeclared(name: string): boolean {
    return this._declared.has(name);
  }

  /**
   * è®¾ç½®ï¼ˆæä¾›ï¼‰ä¸€ä¸ªæœåŠ¡å®ä¾‹
   *
   * ğŸ“ è¿™æ˜¯"æ§åˆ¶åè½¬"çš„ä½“ç°ï¼š
   * - ä¼ ç»Ÿæ–¹å¼ï¼šä½¿ç”¨è€…è‡ªå·±åˆ›å»ºä¾èµ–ï¼ˆnew Database()ï¼‰
   * - IoC æ–¹å¼ï¼šä½¿ç”¨è€…åªå£°æ˜"æˆ‘éœ€è¦ database"ï¼Œç”±æ¡†æ¶æ³¨å…¥
   *
   * å½“æœåŠ¡è¢«è®¾ç½®æ—¶ï¼Œä¼šè§¦å‘ "service" äº‹ä»¶ï¼Œ
   * è®©æ‰€æœ‰é€šè¿‡ ctx.inject() æ³¨å†Œçš„ä¾èµ–æ–¹æ£€æŸ¥æ˜¯å¦å¯ä»¥å¯åŠ¨ã€‚
   *
   * @param name - æœåŠ¡åç§°
   * @param instance - æœåŠ¡å®ä¾‹ï¼Œä¼  null/undefined è¡¨ç¤ºç§»é™¤æœåŠ¡
   */
  set(name: string, instance: any): void {
    // è‡ªåŠ¨å£°æ˜ï¼ˆå¦‚æœè¿˜æ²¡å£°æ˜çš„è¯ï¼‰
    if (!this._declared.has(name)) {
      this._declared.add(name);
    }

    if (instance == null) {
      // ç§»é™¤æœåŠ¡
      this._services.delete(name);
    } else {
      // æ³¨å†ŒæœåŠ¡
      this._services.set(name, instance);
    }

    // ğŸ“ è§¦å‘ "service" äº‹ä»¶ï¼Œé€šçŸ¥æ‰€æœ‰ä¾èµ–æ–¹
    // è¿™æ˜¯ Koishi å®ç°"åŠ¨æ€ä¾èµ–"çš„å…³é”®
    this._root.emit('service', name);
  }

  /**
   * è·å–æœåŠ¡å®ä¾‹
   *
   * @param name - æœåŠ¡åç§°
   * @returns æœåŠ¡å®ä¾‹ï¼Œå¦‚æœæœªæä¾›åˆ™è¿”å› undefined
   */
  get(name: string): any {
    return this._services.get(name);
  }

  /**
   * æ£€æŸ¥æœåŠ¡æ˜¯å¦å¯ç”¨ï¼ˆå·²æä¾›å®ä¾‹ï¼‰
   */
  has(name: string): boolean {
    return this._services.has(name);
  }

  /**
   * è·å–æ‰€æœ‰å·²å£°æ˜çš„æœåŠ¡åç§°
   */
  getAllDeclared(): string[] {
    return [...this._declared];
  }

  /**
   * è·å–æ‰€æœ‰å·²æä¾›å®ä¾‹çš„æœåŠ¡åç§°
   */
  getAllAvailable(): string[] {
    return [...this._services.keys()];
  }
}
