/**
 * Mini-Koishi ç”Ÿå‘½å‘¨æœŸç®¡ç† (Lifecycle)
 *
 * ğŸ“ å­¦ä¹ è¦ç‚¹ï¼š
 * Koishi çš„ç”Ÿå‘½å‘¨æœŸç®¡ç†åŸºäº "disposables" æ¨¡å¼ï¼š
 * 1. æ¯ä¸ªä¸Šä¸‹æ–‡ç»´æŠ¤ä¸€ä¸ª disposables åˆ—è¡¨
 * 2. æ‰€æœ‰æ³¨å†Œçš„ç›‘å¬å™¨ã€ä¸­é—´ä»¶ã€æŒ‡ä»¤ç­‰è¿”å›çš„ dispose å‡½æ•°éƒ½ä¼šè¢«æ”¶é›†
 * 3. å½“ä¸Šä¸‹æ–‡è¢«é”€æ¯æ—¶ï¼ˆä¾‹å¦‚æ’ä»¶å¸è½½ï¼‰ï¼Œè‡ªåŠ¨è°ƒç”¨æ‰€æœ‰ dispose å‡½æ•°
 * 4. è¿™ç¡®ä¿äº†"æ³¨å†Œä»€ä¹ˆå°±æ¸…ç†ä»€ä¹ˆ"ï¼Œä¸ä¼šæœ‰èµ„æºæ³„æ¼
 *
 * æ ¸å¿ƒç”Ÿå‘½å‘¨æœŸäº‹ä»¶ï¼š
 * - readyï¼šåº”ç”¨å¯åŠ¨å®Œæˆ
 * - disposeï¼šä¸Šä¸‹æ–‡è¢«é”€æ¯
 */

import type { Dispose } from './events.js';

// ============================================================================
// Lifecycle ç±»
// ============================================================================

export class Lifecycle {
  /**
   * disposable å‡½æ•°åˆ—è¡¨
   *
   * ğŸ“ è¿™æ˜¯ Koishi æœ€ç²¾å¦™çš„è®¾è®¡ä¹‹ä¸€ï¼š
   * æ¯å½“ä½ é€šè¿‡ ctx.on()ã€ctx.middleware()ã€ctx.command() æ³¨å†Œäº†ä»€ä¹ˆä¸œè¥¿ï¼Œ
   * è¿”å›çš„ dispose å‡½æ•°ä¼šè‡ªåŠ¨è¢«æ”¶é›†åˆ°è¿™ä¸ªåˆ—è¡¨é‡Œã€‚
   *
   * å½“æ’ä»¶è¢«å¸è½½ï¼ˆctx.dispose()ï¼‰ï¼Œè¿™ä¸ªåˆ—è¡¨é‡Œçš„æ‰€æœ‰å‡½æ•°ä¼šè¢«é€ä¸€è°ƒç”¨ï¼Œ
   * ä»è€Œè‡ªåŠ¨æ¸…ç†æ‰€æœ‰å‰¯ä½œç”¨ã€‚å¼€å‘è€…ä¸éœ€è¦æ‰‹åŠ¨ç®¡ç†æ¸…ç†é€»è¾‘ï¼
   */
  private _disposables: Dispose[] = [];

  /** æ˜¯å¦å·²ç»è¢«é”€æ¯ */
  private _disposed = false;

  /**
   * æ”¶é›†ä¸€ä¸ª dispose å‡½æ•°
   *
   * @param dispose - è¦æ”¶é›†çš„æ¸…ç†å‡½æ•°
   * @returns ä¼ å…¥çš„ dispose å‡½æ•°ï¼ˆæ–¹ä¾¿é“¾å¼è°ƒç”¨ï¼‰
   */
  collect(dispose: Dispose): Dispose {
    if (this._disposed) {
      // å¦‚æœå·²ç»é”€æ¯ï¼Œç›´æ¥æ‰§è¡Œæ¸…ç†
      dispose();
      return dispose;
    }
    this._disposables.push(dispose);
    return dispose;
  }

  /**
   * é”€æ¯å½“å‰ç”Ÿå‘½å‘¨æœŸï¼Œæ‰§è¡Œæ‰€æœ‰æ”¶é›†çš„ dispose å‡½æ•°
   *
   * ğŸ“ é”€æ¯é¡ºåºæ˜¯**é€†åº**çš„ï¼ˆåæ³¨å†Œçš„å…ˆæ¸…ç†ï¼‰ï¼Œ
   * è¿™æ ·å¯ä»¥æ­£ç¡®å¤„ç†ä¾èµ–å…³ç³»ï¼š
   * å¦‚æœ A å…ˆæ³¨å†Œï¼ŒB åæ³¨å†Œä¸”ä¾èµ– Aï¼Œ
   * é‚£ä¹ˆ B åº”è¯¥å…ˆè¢«æ¸…ç†ï¼Œç„¶åå†æ¸…ç† Aã€‚
   */
  dispose(): void {
    if (this._disposed) return;
    this._disposed = true;

    // ğŸ“ é€†åºæ‰§è¡Œ dispose å‡½æ•°
    const disposables = this._disposables.splice(0);
    for (const dispose of disposables.reverse()) {
      try {
        dispose();
      } catch (error) {
        console.error('[lifecycle] dispose å‡ºé”™:', error);
      }
    }
  }

  /** æ£€æŸ¥æ˜¯å¦å·²è¢«é”€æ¯ */
  get isDisposed(): boolean {
    return this._disposed;
  }
}
