/**
 * Echo æ’ä»¶ç¤ºä¾‹
 *
 * ğŸ“ è¿™æ˜¯ä¸€ä¸ªæœ€ç®€å•çš„ Koishi æ’ä»¶ç¤ºä¾‹ï¼Œå±•ç¤ºæ’ä»¶çš„åŸºæœ¬ç¼–å†™æ–¹å¼ã€‚
 *
 * åœ¨ Koishi ä¸­ï¼Œæœ€å¸¸è§çš„æ’ä»¶å½¢å¼å°±æ˜¯ä¸€ä¸ªæ™®é€šçš„å‡½æ•°ï¼ˆæˆ–å¸¦ apply çš„å¯¹è±¡ï¼‰ï¼Œ
 * æ¥æ”¶ ctxï¼ˆä¸Šä¸‹æ–‡ï¼‰å’Œ configï¼ˆé…ç½®ï¼‰ä¸¤ä¸ªå‚æ•°ã€‚
 *
 * æ’ä»¶åœ¨ ctx ä¸Šæ³¨å†Œçš„æ‰€æœ‰ä¸œè¥¿ï¼ˆäº‹ä»¶ã€æŒ‡ä»¤ã€ä¸­é—´ä»¶ç­‰ï¼‰ï¼Œ
 * éƒ½ä¼šåœ¨æ’ä»¶å¸è½½æ—¶è‡ªåŠ¨æ¸…ç†â€”â€”å¼€å‘è€…ä¸éœ€è¦æ‰‹åŠ¨ç®¡ç†ã€‚
 */

import { Context } from "../src/index.js";

// ============================================================================
// å‡½æ•°å½¢å¼çš„æ’ä»¶
// ============================================================================

/**
 * echo æ’ä»¶ â€”â€” å›å£°æŒ‡ä»¤
 *
 * ğŸ“ è¿™æ˜¯æœ€ç®€å•çš„å‡½æ•°å½¢å¼æ’ä»¶ï¼š
 * - æ¥æ”¶ ctx å’Œ config
 * - åœ¨ ctx ä¸Šæ³¨å†ŒæŒ‡ä»¤
 *
 * ä½¿ç”¨æ–¹å¼ï¼š
 *   app.plugin(echoPlugin);
 *   // ç„¶åè¾“å…¥ "echo hello" â†’ å›å¤ "hello"
 */
export function echoPlugin(ctx: Context) {
  // æ³¨å†Œ echo æŒ‡ä»¤
  // ğŸ“ <message...> è¡¨ç¤º"å‰©ä½™æ‰€æœ‰å‚æ•°"æ˜¯å¿…é€‰çš„
  ctx
    .command("echo <message>", "å›å£°æŒ‡ä»¤ï¼šé‡å¤ä½ è¯´çš„è¯")
    .action((_opts, args) => {
      // å°†æ‰€æœ‰å‚æ•°æ‹¼æ¥åœ¨ä¸€èµ·ä½œä¸ºå›å¤
      return args.join(" ") || "ä½ ä»€ä¹ˆéƒ½æ²¡è¯´ï¼";
    });
}

// ============================================================================
// å¯¹è±¡å½¢å¼çš„æ’ä»¶
// ============================================================================

/**
 * repeat æ’ä»¶ â€”â€” é‡å¤æŒ‡ä»¤ï¼ˆå¯¹è±¡å½¢å¼ï¼‰
 *
 * ğŸ“ å¯¹è±¡å½¢å¼çš„æ’ä»¶å¯ä»¥æºå¸¦ name å±æ€§ï¼Œ
 * æ–¹ä¾¿åœ¨æ—¥å¿—å’Œè°ƒè¯•ä¸­è¯†åˆ«ã€‚
 *
 * ä½¿ç”¨æ–¹å¼ï¼š
 *   app.plugin(repeatPlugin, { times: 3 });
 *   // ç„¶åè¾“å…¥ "repeat hi" â†’ å›å¤ "hi\nhi\nhi"
 */
export const repeatPlugin = {
  name: "repeat-plugin",

  apply(ctx: Context, config?: { times?: number }) {
    // ğŸ“ ä» config ä¸­è¯»å–é…ç½®ï¼Œæä¾›é»˜è®¤å€¼
    const times = config?.times || 3;

    ctx
      .command("repeat <message>", `é‡å¤ä½ è¯´çš„è¯ ${times} æ¬¡`)
      .option("times", "-t, --times <n>")
      .action((_opts, args) => {
        const message = args.join(" ") || "...";
        // é‡å¤ N æ¬¡
        return Array(times).fill(message).join("\n");
      });
  },
};

// ============================================================================
// å¸¦ä¸­é—´ä»¶çš„æ’ä»¶
// ============================================================================

/**
 * logger æ’ä»¶ â€”â€” æ¶ˆæ¯æ—¥å¿—
 *
 * ğŸ“ è¿™ä¸ªæ’ä»¶å±•ç¤ºäº†å¦‚ä½•åœ¨æ’ä»¶ä¸­æ³¨å†Œä¸­é—´ä»¶ã€‚
 * ä¸­é—´ä»¶ä¼šæ‹¦æˆªæ‰€æœ‰ç»è¿‡çš„æ¶ˆæ¯ï¼Œå¯ä»¥åšæ—¥å¿—ã€è¿‡æ»¤ã€è½¬æ¢ç­‰æ“ä½œã€‚
 */
export function loggerPlugin(ctx: Context) {
  // ğŸ“ æ³¨å†Œä¸€ä¸ªå‰ç½®ä¸­é—´ä»¶ï¼ˆprepend=trueï¼‰ï¼Œç¡®ä¿å®ƒæœ€å…ˆæ‰§è¡Œ
  ctx.middleware((session, next) => {
    // è®°å½•æ”¶åˆ°çš„æ¶ˆæ¯
    const time = new Date().toLocaleTimeString();
    console.log(`ğŸ“ [${time}] ${session.username}: ${session.content}`);

    // ğŸ“ è°ƒç”¨ next() å°†æ§åˆ¶æƒäº¤ç»™ä¸‹ä¸€ä¸ªä¸­é—´ä»¶
    // å¦‚æœä¸è°ƒç”¨ next()ï¼Œæ¶ˆæ¯å¤„ç†æµç¨‹å°±æ­¤ç»ˆæ­¢
    return next();
  }, true); // prepend=true è¡¨ç¤ºå‰ç½®æ’å…¥
}

// ============================================================================
// å¸¦æœåŠ¡çš„æ’ä»¶
// ============================================================================

/**
 * counter æ’ä»¶ â€”â€” è®¡æ•°æœåŠ¡
 *
 * ğŸ“ è¿™ä¸ªæ’ä»¶å±•ç¤ºäº†å¦‚ä½•æä¾›æœåŠ¡ï¼ˆServiceï¼‰ã€‚
 * æœåŠ¡æ³¨å†Œåï¼Œå…¶ä»–æ’ä»¶å¯ä»¥é€šè¿‡ ctx.getService('counter') æ¥ä½¿ç”¨ã€‚
 */
export function counterPlugin(ctx: Context) {
  // ğŸ“ åˆ›å»ºä¸€ä¸ªè®¡æ•°å™¨æœåŠ¡
  const counter = {
    counts: new Map<string, number>(),

    /** å¢åŠ è®¡æ•° */
    increment(key: string): number {
      const current = this.counts.get(key) || 0;
      const next = current + 1;
      this.counts.set(key, next);
      return next;
    },

    /** è·å–è®¡æ•° */
    get(key: string): number {
      return this.counts.get(key) || 0;
    },
  };

  // ğŸ“ å°†è®¡æ•°å™¨æ³¨å†Œä¸ºæœåŠ¡
  ctx.provide("counter", counter);

  // æ³¨å†Œ count æŒ‡ä»¤
  ctx.command("count [key]", "æ˜¾ç¤ºæˆ–å¢åŠ è®¡æ•°").action((_opts, args) => {
    const key = args[0] || "default";
    const value = counter.increment(key);
    return `è®¡æ•°å™¨ "${key}": ${value}`;
  });
}

// ============================================================================
// å¸¦äº‹ä»¶ç›‘å¬çš„æ’ä»¶
// ============================================================================

/**
 * welcome æ’ä»¶ â€”â€” æ¬¢è¿æ¶ˆæ¯
 *
 * ğŸ“ è¿™ä¸ªæ’ä»¶å±•ç¤ºäº†å¦‚ä½•ç›‘å¬ç”Ÿå‘½å‘¨æœŸäº‹ä»¶ã€‚
 */
export function welcomePlugin(ctx: Context) {
  // ğŸ“ ç›‘å¬ ready äº‹ä»¶ï¼ˆåº”ç”¨å¯åŠ¨å®Œæˆåè§¦å‘ï¼‰
  ctx.on("ready", () => {
    console.log("ğŸ‰ Welcome æ’ä»¶å·²å°±ç»ªï¼");
  });

  // ğŸ“ ç›‘å¬ dispose äº‹ä»¶ï¼ˆæ’ä»¶/ä¸Šä¸‹æ–‡è¢«é”€æ¯æ—¶è§¦å‘ï¼‰
  ctx.on("dispose", () => {
    console.log("ğŸ‘‹ Welcome æ’ä»¶å·²å¸è½½ï¼");
  });

  // æ³¨å†Œ hello æŒ‡ä»¤
  ctx
    .command("hello [name]", "æ‰“ä¸ªæ‹›å‘¼")
    .option("times", "-t, --times <n>")
    .action((_opts, args) => {
      console.log(_opts);

      const name = args[0] || "ä¸–ç•Œ";
      return `ä½ å¥½ï¼Œ${name}ï¼æ¬¢è¿ä½¿ç”¨ Mini-Koishi ğŸ‰`;
    });
}
