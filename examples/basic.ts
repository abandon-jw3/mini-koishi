/**
 * Mini-Koishi åŸºç¡€ç¤ºä¾‹
 *
 * ðŸŽ“ è¿™ä¸ªæ–‡ä»¶å±•ç¤ºäº† Mini-Koishi çš„å®Œæ•´ä½¿ç”¨æµç¨‹ï¼š
 * 1. åˆ›å»º App å®žä¾‹
 * 2. åŠ è½½æ’ä»¶
 * 3. æ³¨å†Œä¸­é—´ä»¶å’ŒæŒ‡ä»¤
 * 4. å¯åŠ¨åº”ç”¨
 *
 * è¿è¡Œæ–¹å¼ï¼š
 *   npx tsx examples/basic.ts
 *
 * ç„¶åŽåœ¨ç»ˆç«¯ä¸­è¾“å…¥æŒ‡ä»¤ï¼š
 *   help          â†’ æŸ¥çœ‹æ‰€æœ‰å¯ç”¨æŒ‡ä»¤
 *   echo hello    â†’ å›žå¤ "hello"
 *   repeat hi     â†’ é‡å¤ "hi" 3æ¬¡
 *   hello å°æ˜Ž    â†’ å›žå¤ "ä½ å¥½ï¼Œå°æ˜Žï¼"
 *   count         â†’ è®¡æ•°å™¨ +1
 *   count test    â†’ åä¸º "test" çš„è®¡æ•°å™¨ +1
 *   status        â†’ æŸ¥çœ‹åº”ç”¨çŠ¶æ€
 *   Ctrl+C        â†’ é€€å‡º
 */

import { App } from '../src/index.js';
import {
  echoPlugin,
  repeatPlugin,
  loggerPlugin,
  counterPlugin,
  welcomePlugin,
} from './echo-plugin.js';

// ============================================================================
// åˆ›å»ºåº”ç”¨
// ============================================================================

/**
 * ðŸŽ“ Step 1: åˆ›å»º App å®žä¾‹
 * App ç»§æ‰¿è‡ª Contextï¼Œæ˜¯æ ¹ä¸Šä¸‹æ–‡ã€‚
 * å®ƒå†…éƒ¨å·²ç»è‡ªå¸¦äº† help æŒ‡ä»¤ã€‚
 */
const app = new App();

// ============================================================================
// åŠ è½½æ’ä»¶
// ============================================================================

/**
 * ðŸŽ“ Step 2: åŠ è½½å„ç§æ’ä»¶
 * æ¯æ¬¡ app.plugin() è°ƒç”¨éƒ½ä¼šä¸ºè¯¥æ’ä»¶åˆ›å»ºä¸€ä¸ªç‹¬ç«‹çš„å­ä¸Šä¸‹æ–‡ã€‚
 * æ’ä»¶åœ¨å­ä¸Šä¸‹æ–‡ä¸­æ³¨å†Œçš„æ‰€æœ‰ä¸œè¥¿ï¼Œéƒ½å¯ä»¥åœ¨æ’ä»¶å¸è½½æ—¶è‡ªåŠ¨æ¸…ç†ã€‚
 */

// åŠ è½½æ—¥å¿—æ’ä»¶ï¼ˆè®°å½•æ‰€æœ‰æ¶ˆæ¯ï¼‰
app.plugin(loggerPlugin);

// åŠ è½½ echo æ’ä»¶ï¼ˆå›žå£°æŒ‡ä»¤ï¼‰
app.plugin(echoPlugin);

// åŠ è½½ repeat æ’ä»¶ï¼Œå¹¶ä¼ å…¥é…ç½®ï¼ˆé‡å¤ 3 æ¬¡ï¼‰
app.plugin(repeatPlugin, { times: 3 });

// åŠ è½½æ¬¢è¿Žæ’ä»¶ï¼ˆhello æŒ‡ä»¤ + ç”Ÿå‘½å‘¨æœŸäº‹ä»¶ç›‘å¬ï¼‰
app.plugin(welcomePlugin);

// åŠ è½½è®¡æ•°å™¨æ’ä»¶ï¼ˆæä¾›è®¡æ•°æœåŠ¡ + count æŒ‡ä»¤ï¼‰
app.plugin(counterPlugin);

// ============================================================================
// ç›´æŽ¥åœ¨ App ä¸Šæ³¨å†ŒæŒ‡ä»¤å’Œä¸­é—´ä»¶
// ============================================================================

/**
 * ðŸŽ“ Step 3: ä½ ä¹Ÿå¯ä»¥ç›´æŽ¥åœ¨ App ä¸Šæ³¨å†ŒæŒ‡ä»¤å’Œä¸­é—´ä»¶ï¼Œ
 * ä¸ä¸€å®šè¦é€šè¿‡æ’ä»¶ã€‚ä½†å»ºè®®å°†åŠŸèƒ½å°è£…æˆæ’ä»¶ä»¥ä¾¿å¤ç”¨ã€‚
 */

// æ³¨å†Œä¸€ä¸ª status æŒ‡ä»¤ï¼ˆå±•ç¤ºåº”ç”¨çŠ¶æ€ä¿¡æ¯ï¼‰
app.command('status', 'æŸ¥çœ‹åº”ç”¨çŠ¶æ€')
  .action(() => {
    const commands = app.commands.getCommandNames();
    return [
      'ðŸ“Š åº”ç”¨çŠ¶æ€',
      `  å·²æ³¨å†ŒæŒ‡ä»¤ï¼š${commands.length} ä¸ª`,
      `  æŒ‡ä»¤åˆ—è¡¨ï¼š${commands.join(', ')}`,
    ].join('\n');
  });

// æ³¨å†Œä¸€ä¸ªä¸­é—´ä»¶ï¼Œå¤„ç†æœªåŒ¹é…åˆ°æŒ‡ä»¤çš„æ¶ˆæ¯
app.middleware(async (session, next) => {
  // å…ˆæ‰§è¡ŒåŽç»­ä¸­é—´ä»¶å’ŒæŒ‡ä»¤åŒ¹é…
  await next();
});

// ç›‘å¬æœªå¤„ç†çš„æ¶ˆæ¯
app.on('message/unhandled', (session) => {
  // ðŸŽ“ å½“ç”¨æˆ·è¾“å…¥ä¸åŒ¹é…ä»»ä½•æŒ‡ä»¤æ—¶è§¦å‘
  session.send(`â“ æœªçŸ¥æŒ‡ä»¤: "${session.content}"ï¼Œè¾“å…¥ help æŸ¥çœ‹å¯ç”¨æŒ‡ä»¤`);
});

// ============================================================================
// å¯åŠ¨åº”ç”¨
// ============================================================================

/**
 * ðŸŽ“ Step 4: å¯åŠ¨åº”ç”¨
 * start() ä¼šï¼š
 * 1. åˆ›å»ºå¹¶å¯åŠ¨ CLI é€‚é…å™¨
 * 2. è§¦å‘ ready äº‹ä»¶
 * 3. å¼€å§‹ç­‰å¾…ç»ˆç«¯è¾“å…¥
 */
app.start();

// ðŸŽ“ ç›‘å¬è¿›ç¨‹é€€å‡ºä¿¡å·ï¼Œä¼˜é›…å…³é—­
process.on('SIGINT', async () => {
  await app.stop();
  process.exit(0);
});
